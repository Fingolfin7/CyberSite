{% extends 'core/base.html'%}
{% load crispy_forms_tags %}
{% load static %}

{% block js_includes %}
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawChart);
        function drawChart(selector){
            let totals = [['Severity Level','Count']];
            $.ajax({
                url: '/get_issue_data',
                dataType: 'json',
                async: false,
                cache: false,
                success: function (data) {
                    let result = data.severity_totals;
                    result = Object.keys(result).map((key) => [key, result[key]]);
                    for(i = 0; i < result.length; i++){
                        totals.push(result[i]);
                    }
                }
            });

            totals = google.visualization.arrayToDataTable(totals);
            let options = {
                pieSliceText: 'percentage',
                colors: ['red', 'orange','yellow','green','blue'],
                width:500,
                height:500,
                animation: {duration: 1000, easing: 'out',}
            };
            let chart = new google.visualization.PieChart(document.getElementById('chart'));
            chart.draw(totals, options);
        }
    </script>
{% endblock %} 

{% block content %}
  <div class='card' id="chart"></div>
  <form class="card form"  method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <h3><u>Testing</u></h3>
        <div id="issues-div">
          {{ formset.management_form }}
          {% for form in formset %}
              <div class="inner-card">
                  {% for hidden in form.hidden_fields %} <!--to fix the issue with the 'id' field is required-->
                    {{ hidden }}
                  {% endfor %}

                  {% if not form.errors %}
                  <div class="flex-row">
                  {% else %}
                  <div class="flex-row dark-red">
                  {% endif %}
                      <span class="left">
                        {{ form.DELETE }}
                        {{ form.name }}
                        {{ form.name.errors }}
                        {{ form.non_field_errors }}
                      </span>
                      <span class="right">
                        <button class="button no-border" type="button" id="edit-issue-dropdown"
                        onclick="edit_dropdown($(this))">
                          <i class="material-icons">keyboard_arrow_down</i>
                        </button>
                      </span>
                  </div>
                  <div class="pad-top pd08 dropdown-content" style="display: none;">
                      <div class="even-columns pad-bottom">
                          <span>
                              {{ form.summary }}
                              {{ form.summary.errors }}
                          </span>
                          <span>
                            <div class="pad-bottom width-90">
                                {{ form.severity }}
                                {{ form.severity.errors }}
                            </div>
                          </span>
                      </div>

                      <div class="even-columns pad-bottom">
                          <span>
                              {{ form.description }}
                              {{ form.description.errors }}
                          </span>
                          <span>
                            <div class="pad-bottom pad-right pd1 width-90">
                                {{ form.reference }}
                                {{ form.reference.errors }}
                            </div>
                            <div>
                                {{ form.cvss_rating }}
                                {{ form.cvss_rating.errors }}
                            </div>
                          </span>
                      </div>

                      <div class="pad-bottom flex-columns width-90" id="preview-{{ form.proof_screenshot.id_for_label }}">
                          {% if form.instance.proof_screenshot %}
                              <img src="{{form.instance.proof_screenshot.url}}"
                              style="max-height: 100px;
                              border: 2px solid lightgrey;
                              margin-right: 2%;"/>
                          {% endif %}
                      </div>

                      <div class="top-border">
                        <label class="pad-top" for="{{ form.proof_screenshot.id_for_label }}">
                            <i class="material-icons round-upload">attach_file</i>
                            {{ form.proof_screenshot }}
                        </label>
                      </div>
                  </div>
              </div>
          {% endfor %}
        </div>

        <button type="button" class="forestgreen button no-border" id="add-issue">
          <i class="material-icons">add</i>
          Add Issue
        </button>
        <div class="button-row">
          <a href="#" class="button-link">
            <i class="material-icons md-18 no-padding">arrow_back</i>
            Back
          </a>
          <button type="submit" class="button" id="next">
            Next
            <i class="material-icons md-18 no-padding">arrow_forward</i>
          </button>
        </div>
  </form>
{% endblock %}
