{% extends 'core/base.html'%}
{% load crispy_forms_tags %}
{% load static %}

{% block js_includes %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %} 

{% block content %}
  <div class="card width-25"><canvas id="myChart" ></canvas></div>
  <script>
        const ctx = $('#myChart');
        var ajax_data = [];
        var chart_labels = []
        $.ajax({
            url: '/get_issue_data',
            dataType: 'json',
            async: false,
            cache: false,
            success: function (data) {
                let result = data.severity_totals;
                ajax_data = Object.keys(result).map((key) => result[key]);
                chart_labels = Object.keys(result);
            }
        });
        console.log(ajax_data);
        const myChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: chart_labels,
                datasets: [{
                    label: 'Vulnerability Stats',
                    data: ajax_data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    xAxes: [{
                        gridLines: {
                            display:false
                        }
                    }],
                    yAxes: [{
                        gridLines: {
                            display:false
                        }
                    }]
                }
            }
        });
    </script>
  <form class="card form"  method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <h3><u>Testing</u></h3>
        <div id="issues-div">
          {{ formset.management_form }}
          {% for form in formset %}
              <div class="inner-card">
                  {% for hidden in form.hidden_fields %} <!--to fix the issue with the 'id' field is required-->
                    {{ hidden }}
                  {% endfor %}

                  {% if not form.errors %}
                  <div class="flex-row">
                  {% else %}
                  <div class="flex-row dark-red">
                  {% endif %}
                      <span class="left">
                        {{ form.DELETE }}
                        {{ form.name }}
                        {{ form.name.errors }}
                        {{ form.non_field_errors }}
                      </span>
                      <span class="right">
                        <button class="button no-border" type="button" id="edit-issue-dropdown"
                        onclick="edit_dropdown($(this))">
                          <i class="material-icons">keyboard_arrow_down</i>
                        </button>
                      </span>
                  </div>
                  <div class="pad-top pd08 dropdown-content" style="display: none;">
                      <div class="even-columns pad-bottom">
                          <span>
                              {{ form.summary }}
                              {{ form.summary.errors }}
                          </span>
                          <span>
                            <div class="pad-bottom width-90">
                                {{ form.severity }}
                                {{ form.severity.errors }}
                            </div>
                          </span>
                      </div>

                      <div class="even-columns pad-bottom">
                          <span>
                              {{ form.description }}
                              {{ form.description.errors }}
                          </span>
                          <span>
                            <div class="pad-bottom pad-right pd1 width-90">
                                {{ form.reference }}
                                {{ form.reference.errors }}
                            </div>
                            <div>
                                {{ form.cvss_rating }}
                                {{ form.cvss_rating.errors }}
                            </div>
                          </span>
                      </div>

                      <div class="pad-bottom flex-columns width-90" id="preview-{{ form.proof_screenshot.id_for_label }}">
                          {% if form.instance.proof_screenshot %}
                              <img src="{{form.instance.proof_screenshot.url}}"
                              style="max-height: 100px;
                              border: 2px solid lightgrey;
                              margin-right: 2%;"/>
                          {% endif %}
                      </div>

                      <div class="top-border">
                        <label class="pad-top" for="{{ form.proof_screenshot.id_for_label }}">
                            <i class="material-icons round-upload">attach_file</i>
                            {{ form.proof_screenshot }}
                        </label>
                      </div>
                  </div>
              </div>
          {% endfor %}
        </div>

        <button type="button" class="forestgreen button no-border" id="add-issue">
          <i class="material-icons">add</i>
          Add Issue
        </button>
        <div class="button-row">
          <a href="#" class="button-link">
            <i class="material-icons md-18 no-padding">arrow_back</i>
            Back
          </a>
          <button type="submit" class="button" id="next">
            Next
            <i class="material-icons md-18 no-padding">arrow_forward</i>
          </button>
        </div>
  </form>
{% endblock %}
